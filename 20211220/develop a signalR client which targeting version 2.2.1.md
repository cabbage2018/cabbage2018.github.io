# 一次signalR Client 程序开发对接记录 #
因一个poc 项目的需要我们要用程序去连一个signalR 的服务器。先是抓包分析搞清楚了http request level 的指令流程；接着我开发一个客户端；调研的结果指向了.net 框架的混乱的不兼容的版本，第一个礼拜我使用Javascript 和mocha 搞了一个快速测试，但是仅仅做到hub client connect 函数调用成功，接下来2 周陷入了一个混乱的尝试过程，期间主要碰到了使用了for .net core 的 Javascript module 而导致服务端报错，就把我的方向偏到core 版本和.net 版本的异同。直到第三周我觉得应该好好研究这个技术本身，通过分析隐隐约约感到架构师抓包和用postman 单步模拟跑通的脚本里有大量是signalR 自身产生的； 而不是独立调用post 的结果。于是问题就转换为比较清晰的
- 连接成功
- 模拟必须的post 指令（并不是通过服务端调用，原本ms 设计应该是这样的，但实际操作不是远程调用）
- 通过头部 Bearer 授权
为了稳妥起见还是先用C# 原生的开发状态来编程。

## 开发验证的基础 ##
我们手头有一套手动试通的脚本和能够证明工作的服务器（也响应特定的RESTful API 调用） 忙活了一通以后，忽然想到应该从脚本入手，看看怎么用程序复现这套脚本。这套脚本也是可以说说的：

## 脚本的由来 ##
它是我们架构师根据sdk sample程序 hack 出来的。使用的是另外一个自动化系统，这个系统才安装了sdk。通过客户端sdk连接模拟访问服务器得到的，可以参考Charles 抓包软件的应用。于是，尝试找到该sdk 的C# 代码，编译后从当中看到nuget package 使用的版本，清楚的写着2.2.1 对应2018 年的某个时间发布的，也就是 .net 版本的signalR 废弃前1年左右的更新；

## 成吨的trace 打不出来的信息 ##
原以为有了一套协议调通的经验，后续2 个系统的调试应该不在话下。没想到还是每个系统慢慢调，不到改出成果的时候绝对出不来。原因在于Configure 过程或者按照现场工程师说法叫组态。比如说楼控的服务端实时推 业务需要在取token 之前注册想订阅的topic 实际上专业的叫法是hub。 而一卡通系统需要在websocket 建立之后注册。逻辑次序反了就不工作。这也是无法从trace 里能定位到的故障。人家服务端就这么设计我们客户端只能follow。还有一个地方服务端只能开一个连接，这样主数据RESTFul 和 实时数据互斥无法同时接通，这也花了外国工程师花了一点时间来假设第二个接口服务。
但是这些无效的打trace log 经验却不知不觉教会我如何设置log4js。例如数据量最大的循环数据（请允许我借用PLC 里的概念称呼那些不断更新的数据点位）我们如何压缩； 数据量不大但关键的信息例如登录， 获取token， signalR 连接，定时renew token 的动作，数据库以及mqtt 北向通道接通这些信息放在哪里？异常报警需要用户处理的例如服务器掉线，重连，重连失败，超时，超时回退，这些信息处理不好会撑爆硬盘还是蛮可怕的；另外单元测试的日志，为了了解系统学习系统的日志，为了出报告的日志，等等都有自己的特点并需要分成不同文件或者通道（例如邮件）来进行进一步处理。

```
[2021-10-19T16:41:03.588] [FATAL] routes::signalr - SignalR client connect error: Socket error. ex: Error: getaddrinfo ENOTFOUND desktop-eka5vdd desktop-eka5vdd:8443
[2021-10-19T16:41:03.589] [MARK] routes::signalr - SignalR client disconnected(failed).
[2021-10-19T16:41:11.591] [MARK] routes::signalr - SignalR client reconnecting(387).

```